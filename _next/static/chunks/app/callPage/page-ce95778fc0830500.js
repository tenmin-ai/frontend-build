(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[426],{496:function(e,t,n){Promise.resolve().then(n.bind(n,5483))},5483:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return b}});var r=n(7437),l=n(2265),s=n(4031),c=n(3061),a=n(7776),o=n(1980),i=n(6463);function u(e){let{children:t}=e,n=(0,c.useIsClient)(),{token:l,saveToken:u,backend_url:d}=(0,o.E)(),x=(0,i.useSearchParams)().get("lesson_id");return x?n?(console.log("token",l),(0,r.jsx)(s.eA,{url:d+"/".concat(x)+"?token=".concat(l),label:"call",toast:a.A,autoconnect:!0,wsAuth:!0,children:t})):(0,r.jsx)("div",{children:"Loading.."}):(0,r.jsx)("div",{children:"Invalid lesson"})}var d=n(6920),x=n(5079),f=n(68),m=n(7743),h=n(357);function p(){let e=(0,s.MV)("AUDIO_CALL",{isSpeaking:!1,status:"BACKEND_DISCONNECTED",transcriptFull:"",transcriptPartial:"",captions:"",messages:[]}),t=(0,l.useContext)(s.Dm),n=(0,i.useRouter)(),{tutors:c}=(0,o.E)(),a=(0,i.useSearchParams)(),u=c.find(e=>e._id==a.get("tutor_id")),p=null==u?void 0:u.lessons.find(e=>e.id==a.get("lesson_id")),[b,g]=(0,l.useState)(0),[v,j]=(0,l.useState)(1),[w,y]=(0,l.useState)(!1),[N,k]=(0,l.useState)(!1),[E,T]=(0,l.useState)(!1),C=(0,l.useRef)(null),[S,A]=(0,l.useState)(null),_=()=>{if(S){F();return}navigator.mediaDevices.getUserMedia({video:!0}).then(e=>{A(e);let t=C.current;t?(t.srcObject=e,t.play().catch(e=>console.error("Error playing video:",e)),y(!w),N&&k(!1)):console.error("Video element not found")}).catch(e=>{console.error(e)})},F=()=>{S&&(S.getTracks().forEach(e=>e.stop()),A(null),y(!w))};u||console.error("Tutor not found"),(0,l.useEffect)(()=>((async()=>{await m.P.keepAwake()})(),()=>{(async()=>{await m.P.allowSleep()})()}),[]);let[R,D]=(0,l.useState)(!1),{startSpeaker:I,isPlaying:B}=function(e){let{onPlaybackChange:t,volume:n=1,speed:r=1}=e,c=(0,l.useContext)(s.Dm),a=(0,l.useRef)(null),o=(0,l.useRef)([]),i=(0,l.useRef)(0),u=(0,l.useRef)(null),d=(0,l.useRef)(null),x=(0,l.useRef)(null),[f,m]=(0,l.useState)(!1),h=()=>{if(u.current&&(clearTimeout(u.current),u.current=null),0===o.current.length)return;let e=1,t=o.current.slice(0,1);for(let n of t)if(n&&n.buffer){let t=n.buffer.getChannelData(0);for(let n=0;n<t.length;n++)t[n]=t[n]*e,e-=1/(1*t.length)}o.current.slice(1).forEach(e=>{e.stop()}),o.current=t},p=async e=>{let{i:t,data:n}=e;if(null===a.current){console.error("AudioContext not initialized!");return}0==t&&(o.current.length>0&&h(),i.current=a.current.currentTime);let l=i.current+.1*t/r+.05,s=a.current.currentTime-l;s>0&&(console.log("Audio chunk is late, delaying playback by ".concat(s," seconds.")),l+=s,i.current+=s);let c=a.current.createBufferSource();c.connect(d.current),c.start(l),c.playbackRate.value=r,o.current.push(c),1==o.current.length&&(u.current=setTimeout(()=>{m(!0),u.current=null},50)),c.onended=()=>{o.current.length>0&&o.current.shift(),0===o.current.length&&m(!1)};let x=await new Response(n).arrayBuffer(),f=new Int16Array(x),p=a.current.createBuffer(1,x.byteLength/2,24e3),b=p.getChannelData(0);for(let e=0;e<f.length;e++)b[e]=f[e]/32767;c.buffer=p};return(0,l.useEffect)(()=>{if(!c){console.error("No session found!");return}return c.registerEvent("TTS_CHUNK",p),c.registerEvent("TTS_INTERRUPT",()=>{console.log("TTS_INTERRUPT"),h()}),()=>{null==c||c.deregisterEvent("TTS_CHUNK"),null==c||c.deregisterEvent("TTS_INTERRUPT")}},[c,r]),(0,l.useEffect)(()=>{null==t||t(f)},[f]),(0,l.useEffect)(()=>{d.current&&(d.current.gain.value=n)},[n]),(0,l.useEffect)(()=>{x.current&&(x.current.parameters.get("pitchFactor").value=1/r)},[r]),{isPlaying:f,startSpeaker:()=>{null===a.current&&(a.current=new(window.AudioContext||window.webkitAudioContext),d.current=a.current.createGain(),a.current.audioWorklet.addModule("worklets/phase-vocoder.js").then(()=>{x.current=new AudioWorkletNode(a.current,"phase-vocoder-processor"),d.current.connect(x.current),x.current.connect(a.current.destination),d.current.gain.value=n,x.current.parameters.get("pitchFactor").value=1/r}))}}}({onPlaybackChange:t=>{e.sendAction({type:t?"TTS_PLAYBACK_STARTED":"TTS_PLAYBACK_FINISHED"})},volume:R?.3:1,speed:v}),[L,P]=(0,l.useState)(!1),{activated:U,setActivation:G}=function(e){let{onSpeechStart:t,onSpeechEnd:n,onAudioData:r}=e,s=(0,l.useRef)(null),c=(0,l.useRef)(null),a=(0,l.useRef)(null),[o,i]=(0,l.useState)(!1);(0,l.useEffect)(()=>{o?u():s.current&&d()},[o]);let u=async()=>{try{console.log("blubblub"),console.log(navigator.mediaDevices),c.current=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0}}),console.log(c.current),s.current=new MediaRecorder(c.current),await s.current.start(500),s.current.ondataavailable=e=>{null==r||r(e.data)},a.current=await f.MicVAD.new({workletURL:"/vad/vad.worklet.bundle.min.js",modelURL:"/vad/silero_vad.onnx",ortConfig:e=>{e.env.wasm.wasmPaths="/vad/"},stream:c.current,onSpeechStart:()=>{console.log("User started talking"),null==t||t()},onVADMisfire:()=>{console.log("Nvm, user didn't start talking"),null==n||n(!0)},onSpeechEnd:e=>{console.log("User stopped talking"),null==n||n(!1)}}),a.current.start()}catch(e){console.error("Error accessing microphone:",e)}},d=()=>{if(s.current&&c.current){var e;c.current.getTracks().forEach(e=>e.stop()),s.current.stop(),null===(e=a.current)||void 0===e||e.destroy()}};return{activated:o,setActivation:i}}({onAudioData:n=>{(null==t?void 0:t.isConnected)?e.sendBinary({type:"STREAM_MIC"},n):console.log("Not sending audio data because not connected")},onSpeechStart:()=>{D(!0),e.sendAction({type:"VAD_CHANGED",is_user_speaking:!0})},onSpeechEnd:()=>{D(!1),e.sendAction({type:"VAD_CHANGED",is_user_speaking:!1})}}),[O,M]=(0,l.useState)(600);return(0,l.useEffect)(()=>{if(U&&O>0){let e=setInterval(()=>{M(e=>e-1)},1e3);return()=>clearInterval(e)}},[U,O]),(0,l.useEffect)(()=>{let e=document.getElementById("DEBUG_BOTTOM");e&&e.scrollIntoView({behavior:"smooth"})},[e.messages]),(0,r.jsxs)("div",{className:"flex flex-col justify-between h-full items-center tracking-[-0.02em] px-7",children:[h.env.NEXT_PUBLIC_DEBUG?(0,r.jsxs)("div",{className:"absolute z-50 w-2/3 h-2/3 bg-white/80 border-red-500 border flex flex-col",children:[(0,r.jsx)("p",{className:"text-red-500 text-center",children:"DEBUG-A-TRON-5000"}),(0,r.jsxs)("div",{className:"flex flex-col gap-5 w-full h-full overflow-scroll text-left",children:[e.messages.map((e,t)=>{var n;return(0,r.jsxs)("div",{className:"text-black text-center border border-black bg-blue-500/30 m-3 p-3",children:[(0,r.jsx)("div",{children:null==e?void 0:null===(n=e.role)||void 0===n?void 0:n.toUpperCase()}),(0,r.jsx)("div",{className:"border border-black mb-3"}),(0,r.jsx)("pre",{className:"text-left text-wrap",children:null==e?void 0:e.content})]},t)}),(0,r.jsx)("div",{id:"DEBUG_BOTTOM"})]}),(0,r.jsxs)("div",{className:"flex flex-row gap-3",children:[(0,r.jsx)("button",{className:"border border-black bg-blue-500 p-2",onClick:()=>{I(),e.sendAction({type:"TEST_TTS"})},children:"TEST TTS"}),(0,r.jsx)("input",{type:"range",min:"0.5",max:"1.5",step:"0.05",value:v,onChange:e=>j(parseFloat(e.target.value))}),(0,r.jsxs)("p",{className:"text-black",children:["Speed: ",v]})]})]}):null,(0,r.jsxs)("div",{className:"flex flex-col items-center w-full ",children:[(0,r.jsxs)("div",{className:"flex w-full justify-between items-center",children:[(0,r.jsx)("button",{className:"text-black/60 font-medium text-sm self-start flex items-center bg-black bg-opacity-[10%] w-12 h-12 justify-center rounded-full",onClick:()=>{P(!1),e.sendAction({type:"STOP_CALL"}),G(!1),F(),n.back()},children:(0,r.jsx)(d.G,{icon:x.EOp})}),(0,r.jsx)("div",{className:"font-medium bg-[#63C7B2]/20 text-[#63C7B2] rounded-full h-12 w-20 text-center border-2 border-[#63C7B2] text-lg flex flex-col justify-center",children:(0,r.jsx)("div",{children:"".concat(Math.floor(O/60).toString().padStart(2,"0"),":").concat((O%60).toString().padStart(2,"0"))})})]}),(0,r.jsx)("video",{playsInline:!0,className:"".concat(w?"scale-y-100 mt-10 -scale-x-100":"scale-y-0 h-0 -scale-x-0"," w-full rounded-xl border-black/10 border-[1px] transform transition-all duration-500 object-cover h-[48vh]"),ref:C})]}),(0,r.jsxs)("div",{className:"flex flex-col items-center w-full h-full justify-end absolute bottom-0 gap-5 pb-14 tracking-[-0.02em] px-8 pointer-events-none",children:[(0,r.jsx)("div",{className:"".concat(w?"":"absolute top-1/2 -translate-y-1/2 px-8 pb-6"," w-screen flex flex-col items-center transform transition-all duration-500"),children:(0,r.jsxs)("div",{className:"".concat(w?"w-4/6 py-6 max-h-[20vh]":"w-full py-10 ","   bg-white flex flex-col justify-center mt-10 rounded-xl items-center border-black/10 border-[1px] transition-all duration-500 pointer-events-auto"),children:[(0,r.jsx)("img",{src:null==u?void 0:u.profile_picture_url,alt:"",className:"".concat(N?"w-10":w?"w-16":"w-20"," ").concat(N?"self-start":""," transition-all duration-500 mx-[10%]")}),N?(0,r.jsxs)("div",{className:"px-[10%] mt-5",children:[(0,r.jsx)("p",{className:"font-medium",children:e.captions}),(0,r.jsx)("div",{className:"border-t-black/20 border-t-[1px] my-2"}),(0,r.jsx)("p",{className:"opacity-35",children:"Translations are coming soon! Stay tuned!"})]}):(0,r.jsxs)("div",{className:"flex flex-col items-center",children:[(0,r.jsx)("p",{className:"pt-4 font-medium text-gray-800 text-xl ",children:null==u?void 0:u.name}),w?null:(0,r.jsx)("p",{className:"".concat(""," text-black/50 mt-1 text-center px-5 "),children:null==p?void 0:p.title})]})]})}),"CONNECTED"!==e.status?(0,r.jsxs)("div",{className:"flex w-full gap-4 mt-6 pointer-events-auto",children:[(0,r.jsx)("button",{className:"".concat(w?"text-[#0039FF] text-opacity-100 bg-[#0039FF] bg-opacity-10 ":"text-black text-opacity-50 bg-black bg-opacity-10 ","  text-2xl w-14 h-14 rounded-full"),onClick:()=>{_()},children:(0,r.jsx)(d.G,{icon:w?x.IyC:x.dRd})}),(0,r.jsx)("button",{className:" bg-[#0039FF] text-white font-bold px-4 h-[3.6rem] flex-grow rounded-full flex items-center justify-center",onClick:()=>{L||(P(!0),e.sendAction({type:"START_CALL"}),I(),G(!0),w||k(!0))},children:L?(0,r.jsx)(d.G,{className:"animate-spin",icon:x.LM3}):(0,r.jsx)("p",{className:"font-medium text-lg",children:"Start"})})]}):(0,r.jsxs)("div",{className:"pointer-events-auto flex gap-5 text-xl items-center bg-white px-5 py-3 rounded-full border-black/10 border-[1px]",children:[(0,r.jsx)("button",{className:"".concat(E?"text-[#0039FF] text-opacity-100 bg-[#0039FF] bg-opacity-10 ":"text-black text-opacity-50 bg-black bg-opacity-10 ","  text-2xl w-14 h-14 rounded-full"),onClick:()=>{G(E),T(!E)},children:(0,r.jsx)(d.G,{icon:x.XQY})}),(0,r.jsx)("button",{className:"".concat(N?"text-[#0039FF] text-opacity-100 bg-[#0039FF] bg-opacity-10 ":"text-black text-opacity-50 bg-black bg-opacity-10 ","  text-2xl w-14 h-14 rounded-full"),onClick:()=>{k(!N),w&&F()},children:(0,r.jsx)(d.G,{icon:x.uKJ})}),(0,r.jsx)("button",{className:"".concat(w?"text-[#0039FF] text-opacity-100 bg-[#0039FF] bg-opacity-10 ":"text-black text-opacity-50 bg-black bg-opacity-10 ","  text-2xl w-14 h-14 rounded-full"),onClick:()=>{_()},children:(0,r.jsx)(d.G,{icon:w?x.IyC:x.dRd})}),"CONNECTED"!==e.status?(0,r.jsx)("button",{className:" bg-[#0039FF] text-white font-bold px-4 h-[3.6rem] rounded-full flex items-center justify-center",onClick:()=>{L||(P(!0),e.sendAction({type:"START_CALL"}),I(),G(!0),w||k(!0))},children:L?(0,r.jsx)(d.G,{className:"animate-spin",icon:x.LM3}):(0,r.jsx)("p",{className:"font-medium text-lg",children:"Start"})}):(0,r.jsx)("button",{className:"bg-[#EA0038] text-white text-opacity-95 font-bold w-[3.6rem] h-[3.6rem] rounded-full flex items-center justify-center",onClick:()=>{P(!1),e.sendAction({type:"STOP_CALL"}),G(!1),F(),k(!1)},children:(0,r.jsx)(d.G,{icon:x.j1w,className:"rotate-[135deg]"})})]})]})]})}function b(){return(0,r.jsx)(u,{children:(0,r.jsx)("main",{className:"bg-gradient-to-b from-[#F6F8FF] to-[#F7F8FD] h-screen pb-14 pt-14",children:(0,r.jsx)(p,{})})})}},1980:function(e,t,n){"use strict";n.d(t,{AuthProvider:function(){return i},E:function(){return u}});var r=n(7437),l=n(2265),s=n(6463),c=n(750),a=n(3061);let o=(0,l.createContext)(void 0),i=e=>{let{children:t}=e,n=(0,a.useIsClient)(),[i,u]=(0,l.useState)([]),[d,x]=(0,l.useState)(null),[f,m]=(0,l.useState)([]),h="https://backend-us.tenmin.ai";(0,l.useEffect)(()=>{(async()=>{try{let e=await fetch(h+"/tutors"),t=await e.json();u(t.map(e=>({...e.tutor,lessons:e.lessons})))}catch(e){console.error("Error fetching data:",e)}})()},[h]);let[p,b]=(0,c._)("token","",{initializeWithValue:!1}),g=(0,s.useRouter)(),v=async e=>{try{let t=await fetch(h+"/user",{method:"GET",headers:{Authorization:"Bearer ".concat(e)}}),n=await t.json();console.log(n),x(JSON.parse(n))}catch(e){console.error("Error fetching data:",e)}};return((0,l.useEffect)(()=>{p||g.push("/login"),v(p)},[p,g]),n)?(0,r.jsx)(o.Provider,{value:{token:p,saveToken:b,backend_url:"wss://backend-us.tenmin.ai/ws",tutors:i,user:d,fetchUserData:v,availableTutors:f,setAvailableTutors:m},children:t}):(0,r.jsx)("main",{className:"bg-[#0039FF] h-screen w-screen flex justify-center items-center",children:(0,r.jsx)("img",{src:"tenmin_new_logo_white.svg",alt:"",className:"w-10"})})},u=()=>{let e=(0,l.useContext)(o);if(!e)throw Error("useAuthContext must be used within an AuthProvider");return e}}},function(e){e.O(0,[676,753,404,920,87,971,23,744],function(){return e(e.s=496)}),_N_E=e.O()}]);