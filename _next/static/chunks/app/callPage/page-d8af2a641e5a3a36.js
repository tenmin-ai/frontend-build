(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[426],{496:function(e,t,n){Promise.resolve().then(n.bind(n,5483))},5483:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return m}});var r=n(7437),s=n(2265),l=n(4031),c=n(3061),i=n(7776),a=n(1980),o=n(6463);function u(e){let{children:t}=e,n=(0,c.useIsClient)(),{token:s,saveToken:u,backend_url:d}=(0,a.E)(),f=(0,o.useSearchParams)().get("lesson_id");return f?n?(console.log("token",s),(0,r.jsx)(l.eA,{url:d+"/".concat(f)+"?token=".concat(s),label:"call",toast:i.A,autoconnect:!0,wsAuth:!0,children:t})):(0,r.jsx)("div",{children:"Loading.."}):(0,r.jsx)("div",{children:"Invalid lesson"})}var d=n(6920),f=n(5079),h=n(68);function x(){let e=(0,l.MV)("AUDIO_CALL",{isSpeaking:!1,status:"BACKEND_DISCONNECTED",transcriptFull:"",transcriptPartial:""}),t=(0,s.useContext)(l.Dm);(0,l.$o)(t,i.A);let n=(0,o.useRouter)(),{tutors:c}=(0,a.E)(),u=(0,o.useSearchParams)(),x=c.find(e=>e._id==u.get("tutor_id"));x||console.error("Tutor not found");let[m,g]=(0,s.useState)(!1),{startSpeaker:p,isPlaying:w}=function(e){let{onPlaybackChange:t,volume:n=1}=e,r=(0,s.useContext)(l.Dm),c=(0,s.useRef)(null),i=(0,s.useRef)([]),a=(0,s.useRef)(0),o=(0,s.useRef)(null),u=(0,s.useRef)(null),[d,f]=(0,s.useState)(!1),h=()=>{if(o.current&&(clearTimeout(o.current),o.current=null),0===i.current.length)return;let e=1,t=i.current.slice(0,1);for(let n of t)if(n&&n.buffer){let t=n.buffer.getChannelData(0);for(let n=0;n<t.length;n++)t[n]=t[n]*e,e-=1/(1*t.length)}i.current.slice(1).forEach(e=>{e.stop()}),i.current=t},x=async e=>{let{i:t,data:n}=e;if(null===c.current){console.error("AudioContext not initialized!");return}0==t&&(i.current.length>0&&h(),a.current=c.current.currentTime);let r=a.current+.1*t+.05,s=c.current.currentTime-r;s>0&&(console.log("Audio chunk is late, delaying playback by ".concat(s," seconds.")),r+=s,a.current+=s);let l=c.current.createBufferSource();l.connect(u.current),l.start(r),i.current.push(l),1==i.current.length&&(o.current=setTimeout(()=>{f(!0),o.current=null},50)),l.onended=()=>{i.current.length>0&&i.current.shift(),0===i.current.length&&f(!1)};let d=await new Response(n).arrayBuffer(),x=new Int16Array(d),m=c.current.createBuffer(1,d.byteLength/2,24e3),g=m.getChannelData(0);for(let e=0;e<x.length;e++)g[e]=x[e]/32767;l.buffer=m};return(0,s.useEffect)(()=>{if(!r){console.error("No session found!");return}return r.registerEvent("TTS_CHUNK",x),r.registerEvent("TTS_INTERRUPT",()=>{console.log("TTS_INTERRUPT"),h()}),()=>{null==r||r.deregisterEvent("TTS_CHUNK"),null==r||r.deregisterEvent("TTS_INTERRUPT")}},[r]),(0,s.useEffect)(()=>{null==t||t(d)},[d]),(0,s.useEffect)(()=>{u.current&&(u.current.gain.value=n)},[n]),{isPlaying:d,startSpeaker:()=>{null===c.current&&(c.current=new(window.AudioContext||window.webkitAudioContext),u.current=c.current.createGain(),u.current.connect(c.current.destination),u.current.gain.value=n)}}}({onPlaybackChange:t=>{e.sendAction({type:t?"TTS_PLAYBACK_STARTED":"TTS_PLAYBACK_FINISHED"})},volume:m?.3:1}),{activated:v,setActivation:b}=function(e){let{onSpeechStart:t,onSpeechEnd:n,onAudioData:r}=e,l=(0,s.useRef)(null),c=(0,s.useRef)(null),i=(0,s.useRef)(null),[a,o]=(0,s.useState)(!1);(0,s.useEffect)(()=>{a?u():l.current&&d()},[a]);let u=async()=>{try{console.log(navigator.mediaDevices),c.current=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0}}),l.current=new MediaRecorder(c.current),await l.current.start(500),l.current.ondataavailable=e=>{null==r||r(e.data)},i.current=await h.MicVAD.new({workletURL:"/vad/vad.worklet.bundle.min.js",modelURL:"/vad/silero_vad.onnx",ortConfig:e=>{e.env.wasm.wasmPaths="/vad/"},stream:c.current,onSpeechStart:()=>{console.log("User started talking"),null==t||t()},onVADMisfire:()=>{console.log("Nvm, user didn't start talking"),null==n||n(!0)},onSpeechEnd:e=>{console.log("User stopped talking"),null==n||n(!1)}}),i.current.start()}catch(e){console.error("Error accessing microphone:",e)}},d=()=>{if(l.current&&c.current){var e;c.current.getTracks().forEach(e=>e.stop()),l.current.stop(),null===(e=i.current)||void 0===e||e.destroy()}};return{activated:a,setActivation:o}}({onAudioData:n=>{(null==t?void 0:t.isConnected)?e.sendBinary({type:"STREAM_MIC"},n):console.log("Not sending audio data because not connected")},onSpeechStart:()=>{g(!0),e.sendAction({type:"VAD_CHANGED",is_user_speaking:!0})},onSpeechEnd:()=>{g(!1),e.sendAction({type:"VAD_CHANGED",is_user_speaking:!1})}});return(0,r.jsxs)("div",{className:"flex flex-col justify-between h-full items-center",children:[(0,r.jsxs)("div",{className:"flex flex-col items-center w-full",children:[(0,r.jsxs)("div",{className:"flex w-full justify-between items-center",children:[(0,r.jsxs)("button",{className:"text-white font-medium text-[1.1rem] self-start ml-10 flex items-center",onClick:()=>{n.back()},children:[(0,r.jsx)(d.G,{icon:f.A35}),(0,r.jsx)("p",{className:"ml-2 text-[1.3rem]",children:"Back"})]}),(0,r.jsx)("button",{className:"text-transparent font-bold text-xl self-start mr-10",children:(0,r.jsx)(d.G,{icon:f.A35})})]}),(0,r.jsx)("img",{src:null==x?void 0:x.profile_picture_url,alt:"",className:"w-24 mt-10"}),(0,r.jsx)("p",{className:"pt-4 font-semibold text-white text-xl ",children:null==x?void 0:x.name}),(0,r.jsxs)("div",{className:"mt-20",children:[(0,r.jsx)("span",{className:"text-white text-center inline",children:e.transcriptFull}),(0,r.jsx)("span",{className:"text-green-500 text-center inline",children:e.transcriptPartial})]})]}),(0,r.jsxs)("div",{className:"flex flex-col items-center mt-10",children:[(0,r.jsx)("div",{className:"w-4 h-4 rounded-full mr-2 ".concat(m?"bg-green-500":"bg-red-500")}),(0,r.jsx)("p",{className:"text-white text-sm",children:m?"VAD: User is speaking":"VAD: User is silent"})]}),(0,r.jsxs)("div",{className:"flex gap-10 text-xl items-center",children:[(0,r.jsx)("button",{className:"text-white text-opacity-85 text-xl bg-white bg-opacity-10 w-14 h-14 rounded-full",onClick:()=>i.A.info("This feature is not available yet!"),children:(0,r.jsx)(d.G,{icon:f.UFh})}),"CONNECTED"!==e.status?(0,r.jsx)("button",{className:" bg-green-600 text-white text-opacity-85 font-bold w-[4.5rem] h-[4.5rem] rounded-full flex items-center justify-center",onClick:()=>{e.sendAction({type:"START_CALL"}),p(),b(!0)},children:(0,r.jsx)(d.G,{icon:f.j1w})}):(0,r.jsx)("button",{className:"bg-[#FD3A31] text-white text-opacity-95 font-bold w-[4.5rem] h-[4.5rem] rounded-full flex items-center justify-center",onClick:()=>{e.sendAction({type:"STOP_CALL"}),b(!1)},children:(0,r.jsx)(d.G,{icon:f.j1w,className:"rotate-[135deg]"})}),(0,r.jsx)("button",{className:"text-white text-opacity-85 text-xl bg-white bg-opacity-10 w-14 h-14 rounded-full",children:(0,r.jsx)(d.G,{icon:f.X8G})})]})]})}function m(){return(0,r.jsx)(u,{children:(0,r.jsx)("main",{className:"bg-gradient-to-b from-[#000000] via-[#151516] via-15% to-[#151516] h-screen pb-10 pt-12",children:(0,r.jsx)(x,{})})})}},1980:function(e,t,n){"use strict";n.d(t,{AuthProvider:function(){return o},E:function(){return u}});var r=n(7437),s=n(2265),l=n(6463),c=n(750),i=n(3061);let a=(0,s.createContext)(void 0),o=e=>{let{children:t}=e,n=(0,i.useIsClient)(),[o,u]=(0,s.useState)([]),d="https://backend-us.tenmin.ai";(0,s.useEffect)(()=>{(async()=>{try{let e=await fetch(d+"/tutors"),t=await e.json();u(t.map(e=>({...e.tutor,lessons:e.lessons})))}catch(e){console.error("Error fetching data:",e)}})()},[d]);let[f,h]=(0,c._)("token","",{initializeWithValue:!1}),x=(0,l.useRouter)();return((0,s.useEffect)(()=>{f||x.push("/login")},[f,x]),n)?(0,r.jsx)(a.Provider,{value:{token:f,saveToken:h,backend_url:"wss://backend-us.tenmin.ai/ws",tutors:o},children:t}):(0,r.jsx)("div",{children:"Loading.."})},u=()=>{let e=(0,s.useContext)(a);if(!e)throw Error("useAuthContext must be used within an AuthProvider");return e}}},function(e){e.O(0,[676,753,772,61,920,776,504,971,23,744],function(){return e(e.s=496)}),_N_E=e.O()}]);